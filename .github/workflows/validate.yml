name: Validate Kubernetes Manifests

on:
  pull_request:
    paths:
      - 'k8s/**'
      - '.github/workflows/**'
  push:
    branches:
      - main
    paths:
      - 'k8s/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Install yq for YAML processing
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 || \
            curl -L https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -o /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq
          yq --version || echo "âš ï¸ yq installation failed"

      - name: Validate YAML syntax
        run: |
          echo "ðŸ” Validating YAML syntax..."
          errors=0
          
          for file in $(find k8s -name "*.yml" -o -name "*.yaml"); do
            if command -v yq >/dev/null 2>&1; then
              if ! yq eval '.' "$file" >/dev/null 2>&1; then
                echo "âŒ Invalid YAML syntax in $file"
                errors=$((errors + 1))
              fi
            else
              # Fallback: basic YAML check
              if ! python3 -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null; then
                echo "âŒ Invalid YAML syntax in $file"
                errors=$((errors + 1))
              fi
            fi
          done
          
          if [ $errors -gt 0 ]; then
            echo "âŒ Found $errors YAML syntax errors"
            exit 1
          fi
          echo "âœ… All YAML files have valid syntax"

      - name: Check for StorageClass resources
        run: |
          echo "ðŸ” Checking for StorageClass resources..."
          storageclass_files=""
          
          for file in $(find k8s -name "*.yml" -o -name "*.yaml"); do
            if grep -qE "^\s*kind:\s*StorageClass\s*$" "$file"; then
              storageclass_files="${storageclass_files}\n  - $file"
            fi
          done
          
          if [ -n "$storageclass_files" ]; then
            echo "âŒ ERROR: StorageClass resources found in manifests:"
            echo -e "$storageclass_files"
            echo ""
            echo "StorageClasses are managed by AKS and should not be in manifests."
            echo "Please remove these StorageClass definitions."
            exit 1
          fi
          echo "âœ… No StorageClass resources found"

      - name: Validate Kubernetes resource schemas
        run: |
          echo "ðŸ” Validating Kubernetes resource schemas..."
          errors=0
          
          # Function to validate a manifest file
          validate_manifest() {
            local file=$1
            local kind=$(grep -E "^\s*kind:\s*" "$file" | head -1 | awk '{print $2}' | tr -d '"' | tr -d "'")
            local name=$(grep -A 5 "kind:" "$file" | grep -E "^\s*name:\s*" | head -1 | awk '{print $2}' | tr -d '"' | tr -d "'")
            
            if [ -z "$kind" ]; then
              echo "âš ï¸  Warning: Could not determine kind in $file"
              return 0
            fi
            
            # Use kubectl dry-run to validate
            if kubectl apply --dry-run=client -f "$file" >/dev/null 2>&1; then
              echo "âœ… $kind/$name in $file"
              return 0
            else
              local error=$(kubectl apply --dry-run=client -f "$file" 2>&1)
              # Ignore immutability errors in dry-run (these are expected for existing resources)
              if echo "$error" | grep -qE "StorageClass.*is invalid|PersistentVolumeClaim.*is invalid|StatefulSet.*is invalid|Forbidden.*updates"; then
                echo "âš ï¸  Warning: $kind/$name in $file may have immutability conflicts (expected for existing resources)"
                return 0
              else
                echo "âŒ Validation failed for $kind/$name in $file:"
                echo "$error" | head -5
                return 1
              fi
            fi
          }
          
          # Validate all manifests
          for file in $(find k8s -name "*.yml" -o -name "*.yaml"); do
            if ! validate_manifest "$file"; then
              errors=$((errors + 1))
            fi
          done
          
          if [ $errors -gt 0 ]; then
            echo "âŒ Found $errors validation errors"
            exit 1
          fi
          echo "âœ… All manifests validated successfully"

      - name: Check for immutable field changes
        run: |
          echo "ðŸ” Checking for potential immutability issues..."
          warnings=0
          
          # Check PVCs for storageClassName changes
          for file in $(find k8s -name "*pvc*.yml" -o -name "*pvc*.yaml"); do
            if [ -f "$file" ]; then
              echo "ðŸ“‹ Checking PVC in $file"
              if grep -q "storageClassName" "$file"; then
                echo "  â„¹ï¸  PVC has storageClassName defined (immutable after creation)"
                echo "  âš ï¸  If this PVC already exists, changing storageClassName will fail"
              fi
            fi
          done
          
          # Check StatefulSets for volumeClaimTemplates
          for file in $(find k8s -name "*statefulset*.yml" -o -name "*statefulset*.yaml"); do
            if [ -f "$file" ]; then
              echo "ðŸ“‹ Checking StatefulSet in $file"
              if grep -q "volumeClaimTemplates" "$file"; then
                echo "  â„¹ï¸  StatefulSet has volumeClaimTemplates (immutable after creation)"
                echo "  âš ï¸  If this StatefulSet already exists, changing volumeClaimTemplates will fail"
              fi
            fi
          done
          
          echo "âœ… Immutability check complete"

      - name: Validate deployment workflow consistency
        run: |
          echo "ðŸ” Validating deployment workflow consistency..."
          
          # Check that all service directories referenced in deploy.yml exist
          services=("user-management" "notification-service" "routing-service" "safety-scoring" "sos" "feedback")
          
          for service in "${services[@]}"; do
            service_dir="k8s/saferoute/${service}"
            if [ ! -d "$service_dir" ]; then
              echo "âš ï¸  Warning: Service directory $service_dir not found but referenced in deploy.yml"
            elif [ ! -f "${service_dir}/deployment.yml" ]; then
              echo "âš ï¸  Warning: deployment.yml not found in $service_dir"
            fi
          done
          
          echo "âœ… Workflow consistency check complete"

      - name: Summary
        if: always()
        run: |
          echo "## âœ… Manifest Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All Kubernetes manifests have been validated for:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… YAML syntax" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… No StorageClass resources" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Kubernetes resource schemas" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Immutability warnings" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Workflow consistency" >> $GITHUB_STEP_SUMMARY

